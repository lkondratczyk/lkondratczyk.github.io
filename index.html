<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
	<title>SF Neighborhoods</title>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js">
			</script>
	<link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css" 
			rel="stylesheet" />
	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>	

	<style>
		#header {
			width : 100%;
			height : 15%;
			font-size: 3vmin;
		}
    	#tabList { 
			overflow-y:scroll; 
			width : 100%;
			height : 85%;
		}
		.Map {
			position : absolute;
			top : 0;
			right : 0;
			width : 100%;
			height : 100%;
		}
		.Sidebar {
			position : absolute;
			top : 15px;
			left : 15px;
			width : 30%;
			height : 80%;
		}
	</style>
</head>
<body>
	<div class = "Map" id = "map"></div>
	<div class = "Sidebar">
		<div id = "header"><h3><center><u>
				San Francisco Neighborhoods</u></center></h3></div>
		<div id = "tabList" ></div>
	</div>
	<script>
		
		/******SET STYLES BELOW******/
	
		//Style settings for polygons when hovered over
		var highlightArea = {
			fillOpacity: 0.65,
			fillColor: 'blue'
		};
		
		//Default style settings for polygons not in Bold Italic
		var infoArea = {
			color: 'blue', 
			weight: 3, 
			fillColor: 'transparent'
		};
		
		//Default style settings for polygons in Bold Italic
		var articleArea ={
			color: 'blue', 
			weight: 3,
			opacity: 0.6,
			fillOpacity: 0.3,
			fillColor: 'blue'
		};
		
		//Custom icon for map pins
		var badgerIcon = L.icon({
			iconUrl: 'badgerIcon.png',
			shadowUrl: 'badgerShadow.png',
			iconSize:     [60, 60],
			shadowSize:   [67, 42], 
			iconAnchor:   [30, 60], 
			shadowAnchor: [0, 42], 
			popupAnchor:  [-3, -76]
		});
		
		//Sets style for tabs in their resting state
		function setTabInactive(div) {
			div.style.display = "block";
			div.style.width = "100%";
			div.style.height = "15%";
			div.style.background = "white";
			div.style.color = "black";
			div.style.fontSize = "100%";
		};
		
		//Sets style for tabs in their highlighted state
		function setTabActive(div) {
			div.style.background = "grey";
		};
		
		/******VARIABLES******/
		
		//The map
    	var map = L.map('map').setView([37.7470, -122.4867], 12);
		
		//Saves neighborhoods as objects to be sorted & used later
		var neighborhoodList = [];
		
		/******FUNCTIONS******/
		
		//For adding hover events to tabs
		function tabHover(feature, div){
			$(document).ready(function() {
				$(div).hover(
					//Function for hover in
					function() { 
						setTabActive(div);
						map.eachLayer(function (layer) {
							if(layer._polygonId === div.id){
								layer.setStyle(highlightArea);
							}
						});						
					},
					//Function for hover out
				    function() { 
						setTabInactive(div);
						map.eachLayer(function (layer) {
							if(layer._polygonId === div.id){
								if(feature.properties.inBI === "true"){
									layer.setStyle(articleArea);
								}
								else{
									layer.setStyle(infoArea);
								}
							}
						});	
					}
				);
			});
		}
		
		//Creates each entry for the list of tabs
		function createTab(feature){
			var div = document.createElement("a");
			div.id = feature.properties.name.replaceAll(" ", "+");
			setTabInactive(div);
			div.innerHTML = feature.properties.name;
			div.style.cursor = "pointer";
			tabHover(feature, div);
			//Adds click events to tabs
			$(div).click(function(){
				map.eachLayer(function (layer) {
					if(layer._polygonId === div.id){
						layer.openPopup();
					}
				});	
			});
			return div;
		}

		//Sorts tabs and adds them to the proper div
		function addTabs(neighborhoodList) {
			neighborhoodList.sort(compare);
			for(i = 0; i < neighborhoodList.length; i++){
				document.getElementById("tabList").appendChild(
						createTab(neighborhoodList[i]));
			}
		}
		
		//Creates an area to put neighborhood name information
		function createNameTool(){
			var nameTool = $("<p></p>", {
				id: ("nameTool"),
				css: {
					position: "absolute",
					top: window.event.clientY,
					left: window.event.clientX,
					zIndex: 1002,
					backgroundColor: "white",
					padding: "8px",
					border: "1px solid #ccc"
				}
			});
			return nameTool;
		}
		
		//Creates the text for neighborhood names to be put in the nameTool box
		function createLabel(feature){
			var label = $("<p></p>", {
				text: feature.properties.name,
				css: {fontSize: "12px", marginBottom: "3px"}
			});
			return label;
		}
		
		//Manages addition of hover events 
		function addAreaHover(feature, layer){
			layer.on("mouseover", function(e){
				layer.setStyle(highlightArea);
				var nameTool = createNameTool();
				var label = createLabel(feature);
				label.appendTo(nameTool);
				nameTool.appendTo("#map");
			});
			layer.on("mouseout", function(e){
				$("#nameTool").remove();
				if(feature.properties.inBI === "true"){
					layer.setStyle(articleArea);
				}
				else{
					layer.setStyle(infoArea);
				}
			});
		}
		
		//For adding popups to neighborhoods
		function addPopups(feature, layer){
			var hrefCL = "http://sfbay.craigslist.org/search/apa?query=\"" + 
					feature.properties.name.replaceAll(" ", "+")
					.replaceAll("/", '"%7C"') + '"';
			var linkCL = "<a href =" + hrefCL + " target = '_blank'>" +
							"CraigsList Rentals</a>"
			if(feature.properties.inBI === "true"){
				var popupOptions = {
					'minWidth': screen.width/2 + 'px',
					'maxWidth': screen.width/2 + 'px',
					'autopan': true,
					'keepInView': true
				}
				var image = "<a href=" + feature.properties.LINK + " target="+ 
						"'_blank'><img src = " + feature.properties.popImg + 
						" alt = " +	feature.properties.name+" width = " + 
						screen.width/2 + "></img>";
				layer.bindPopup(image + "<br/>" + linkCL, popupOptions);
			}
			else{
				if(feature.properties.LINK == null){
					layer.bindPopup('<h3>' + feature.properties.name + 
							'</h3>' + linkCL);
				}
				else{
					layer.bindPopup('<h3>'+feature.properties.name+'<a href ='+
							feature.properties.LINK + ' target = "_blank">' +
							' (info) </a></h3>' + linkCL);
				}
			}
		}
		
		//Manages qualities added to each map featur
		function onEachFeature(feature, layer){
			layer._polygonId = feature.properties.name.replaceAll(" ", "+");
			addPopups(feature, layer);
			addAreaHover(feature, layer);
		}
		
		//A comparator for sorting an array of neighborhood objects
		function compare(a,b) {
		  if (a.properties.name < b.properties.name)
			return -1;
		  if (a.properties.name > b.properties.name)
			return 1;
		  return 0;
		}
		
		//Replaces characters in strings (needed for CraigsList query URLs)
		String.prototype.replaceAll = function(str1, str2, ignore) {
			return this.replace(new RegExp(str1.replace(
					/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),
					(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(
					/\$/g,"$$$$"):str2);
		} 
		
		//Creates polygons from json file and initializes their styles/features
		$.getJSON("https://gist.githubusercontent.com/lkondratczyk/51d43e0a7c9"+
				"68119a78e/raw/50dc84e629d0b86d33172697497494791fa01314/hoodBo"+
				"rders", function(response) {
            console.log("response", response);
            L.geoJson(response, {
				style: function (feature) {
					neighborhoodList.push(feature);
					if(feature.properties.inBI === "true"){
						return articleArea;
					}
					else{
						return infoArea;
					}
				},
				onEachFeature: onEachFeature
			}).addTo(map).pipe(addTabs(neighborhoodList));	 
        });
		
		//Access token for Mapbox map tiles
		L.mapbox.accessToken = 				
			'pk.eyJ1IjoibGtvbmRyYXRjenlrIiwiYSI6ImVlNjAzNTYwYTBjZDMwYzg5YjViY' +
			'2U0MTQ3MTMzYzU3In0.DDlX4LfLLK0iguFHb9OTqQ';
			
		//Adds the Mapbox tiles to the map
		L.tileLayer('https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{' + 
				'y}.png?access_token=' + L.mapbox.accessToken , {
    			attribution: '<a href="http://www.mapbox.com/about/maps/" ' + 
						'target="_blank">Mapbox</a>',
   			 	maxZoom: 18,
		}).addTo(map);

		//uncomment this to see Badger Maps icon
		//L.marker([37.7270, -122.4367], {icon: badgerIcon}).addTo(map);
	</script>
</body>
</html>