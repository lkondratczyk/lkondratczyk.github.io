<!DOCTYPE html>
<html>
<head>
	<title>SF Neighborhoods</title>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js"></script>
	<link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css" rel="stylesheet" />
	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>	

    <style>
    	#map { height: 700px; }
	</style>
</head>
<body>
	<div id = "list"></div>
	<div id = "map"></div>
	<script>
		//The map
    	var map = L.map('map').setView([37.7200, -122.4167], 12);

		//Style settings for polygons when hovered over
		var highlightStyle = {
			color: 'blue', 
			weight: 3,
			opacity: 0.6,
			fillOpacity: 0.65,
			fillColor: 'blue'
		};
		
		//Default style settings for polygons not in Bold Italic
		var inactiveStyle = {
			color: 'transparent', 
			fillColor: 'transparent'
		};
		
		//Default style settings for polygons in Bold Italic
		var activeStyle ={
			color: 'blue', 
			weight: 3,
			opacity: 0.6,
			fillOpacity: 0.3,
			fillColor: 'blue'
		};

		//Loads an image referenced by link in hoodBorders.json popImg property
		function loadImage(feature, layer){
			var image = document.createElement("IMG");
			image.setAttribute("src", feature.properties.popImg);
			image.setAttribute("width", "400");
			image.setAttribute("id", feature.properties.name);
			linkImage(feature, layer, image);
			return image;
		}
		
		//Links image to source article when clicked
		function linkImage(feature, layer, image){
			image.style.cursor = "pointer";
			image.onclick = function() {
				var url = feature.properties.LINK;
				window.open(url, '_blank');
			};
		}
		
		//Creates an area to put neighborhood name information
		function createNameTool(){
			var nameTool = $("<div></div>", {
				id: ("nameTool"),
				css: {
					position: "absolute",
					top: window.event.clientY,
					left: window.event.clientX,
					zIndex: 1002,
					backgroundColor: "white",
					padding: "8px",
					border: "1px solid #ccc"
				}
			});
			return nameTool;
		}
		
		//Creates the text for neighborhood names to be put in the nameTool box
		function createLabel(feature, layer){
			var label = $("<div></div>", {
				text: feature.properties.name,
				css: {fontSize: "12px", marginBottom: "3px"}
			});
			return label;
		}
		
		//Manages addition of hover events 
		function addHoverEvents(feature, layer){
			layer.on("mouseover", function(e){
				layer.setStyle(highlightStyle);
				var nameTool = createNameTool();
				var label = createLabel(feature, layer);
				label.appendTo(nameTool);
				nameTool.appendTo("#map");
			});
			layer.on("mouseout", function(e){
				$("#nameTool").remove();
				if(feature.properties.inBI === "true"){
					layer.setStyle(activeStyle);
				}
				else{
					layer.setStyle(inactiveStyle);
				}
			});
		}

		//Manages information displayed in popup windows when clicked
		function addPopups(feature, layer){
			if(feature.properties.inBI === "true"){
				var image = loadImage(feature, layer);
				var popupOptions = {
					'minWidth': '400px',
					'maxWidth': '400px',
				}
				layer.bindPopup(image, popupOptions);
			}
			else{
				if(feature.properties.LINK == null){
					layer.bindPopup(feature.properties.name, popupOptions);
				}
				else{
					layer.bindPopup('<a href ='+ feature.properties.LINK +' target = "_blank">'+
							feature.properties.name+'</a>', popupOptions);
				}
			}
		}
		
		//Manages additional features for the map
		function featureEvents(feature, layer){
			addPopups(feature, layer);
			addHoverEvents(feature, layer);
		}
		
		//Creates polygons from json file and initializes their styles/features
		$.getJSON("https://gist.githubusercontent.com/lkondratczyk/51d43e0a7c"+
				"968119a78e/raw/aa311590ccef10c91b83d93e10b94e72e82e5426/hood"+
				"Borders", function(response) {
            console.log("response", response);
            L.geoJson(response, {
				style: function (feature) {
					if(feature.properties.inBI === "true"){
						return activeStyle;
					}
					else{
						return inactiveStyle;
					}
				},
				onEachFeature: featureEvents
			}).addTo(map);	 
        });

		//Access token for Mapbox map tiles
		L.mapbox.accessToken = 				
			'pk.eyJ1IjoibGtvbmRyYXRjenlrIiwiYSI6ImVlNjAzNTYwYTBjZDMwYzg5YjViY2U0MTQ3MTMzYzU3In0.' +
			'DDlX4LfLLK0iguFHb9OTqQ';
			
		//Adds the Mapbox tiles to the map
		L.tileLayer('https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' 
			+ L.mapbox.accessToken , {
    			attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>',
   			 	maxZoom: 18,
		}).addTo(map);	
	</script>
</body>
</html>